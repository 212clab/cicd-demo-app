name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 1. Docker Buildx ì„¤ì • (ë©€í‹° í”Œë«í¼ ë¹Œë“œë¥¼ ìœ„í•œ ì„¤ì •)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 2. Frontend ë¹Œë“œ ë° í‘¸ì‹œ (ë©€í‹° í”Œë«í¼)
      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend # ë¹Œë“œí•  ë””ë ‰í† ë¦¬
          push: true # ë¹Œë“œ í›„ í‘¸ì‹œ
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest
          platforms: linux/amd64,linux/arm64 # <-- ì´ ë¶€ë¶„ì´ í•µì‹¬!

      # 3. Backend ë¹Œë“œ ë° í‘¸ì‹œ (ë©€í‹° í”Œë«í¼)
      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend # ë¹Œë“œí•  ë””ë ‰í† ë¦¬
          push: true # ë¹Œë“œ í›„ í‘¸ì‹œ
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest
          platforms: linux/amd64,linux/arm64 # <-- ì´ ë¶€ë¶„ì´ í•µì‹¬!

      # --- ê¸°ì¡´ì— ìˆë˜ ë‹¤ë¥¸ ìŠ¤í…ë“¤ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤ ---

      - name: Test Backend
        run: |
          cd backend
          npm install
          npm test

      - name: Deployment notification
        run: |
          echo "âœ… Images pushed to GHCR"
          echo "ğŸ”„ Watchtower will auto-deploy in 5 minutes"
